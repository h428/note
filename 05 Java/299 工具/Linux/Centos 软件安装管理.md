[TOC]

# 1. 软件包管理简介

## 1.1 软件包分类

1. 源码包
    - 比如tar.gz，最开始是纯源代码包
    - 好处：开源
    - 注意：Windows的软件在Linux中装不了
    - 好处：Windows中绝大多数的病毒 威胁程序 对Linux来讲是无效的，因为Linux根本不认识
    - 坏处：程序需要重新开发而不能和Windows一样再调用
2. 二进制包（RPM包、系统默认包）
3. 脚本安装包(实际上并没有这一类)，任何包不是源码包就是RPM包。

## 1.2 源码包

- 源码包的优点：
    - 开源，如果有足够的能力，可以修改源代码
    - 可以自由选择所需的功能
    - 软件是编译安装，所以更加适合自己的系统，更加稳定也效率更高
    - 卸载方便
- 源码包的缺点：
    - 安装过程步骤较多，尤其安装较大的软件集合时（比如LAMP环境搭建），容易出现拼写错误。
    - 编译过程时间较长，安装比二进制安装时间长
    - 因为是编译安装，安装过程一旦报错新手很难解决

## 1.3 RPM包（即二进制包）

- 二进制包的优点：
    - 包管理系统简单，只通过几个命令就可以实现包的安装、升级、查询和卸载
    - 安装速度比源码包安装快得多
- 二进制包的缺点：
    - 经过编译，不再可以看到源代码
    - 功能选择不如源码包灵活
    - 由于不是本机编译，而是厂商编译好的，所以软件的效率不如源码包
    - 依赖性（讲rpm包安装时详细来讲）。简单理解就是，装软件包A时，他需要软件包B，装软件包B时又需要软件包C，这种情况需要先安装软件包C，再装B和A。Linux基本上每个包都需要依赖。

## 1.4 脚本安装包

- 所谓的脚本安装包，就是把复杂的软件包安装过程写成了程序脚本，初学者可以执行程序脚本实现一键安装
- 但实际安装的还是源码包和二进制包
- 优点：安装简单、快捷
- 缺点：完全丧失了自定义性

# 2. rpm命令管理

## 2.1 RPM包命名规则

1. RPM包的来源
    - RPM包在系统光盘中

        1. 先在mnt目录下创建一个cdrom文件夹，用于挂载光盘镜像文件  mkdir /mnt/cdrom
        2. 然后将光盘挂载到/mnt/cdrom文件夹下  mount /dev/sr0 /mnt/cdrom
        3. 进入到挂载目录，并进入到Pakage目录，所有的rpm文件都在这个目录下
2. RPM 包命名规则

    - 形如：httpd-2.2.15-15.el6.centos.1.i686.rpm
        名称| 含义
        :---:|:---:
        httpd | 软件包名
        2.2.15 | 软件版本
        15 | 软件发布的次数
        el6.centos | 适合的Linux平台
        i686 | 适合的硬件平台
        rpm | rpm包扩展名

3. RPM包依赖性

1. 树形依赖： a --> b --> c
2. 环形依赖： a --> b --> c --> a（需要将a b c包含在一个命令中）
3. 模块依赖： 模块依赖，
    - (依赖某个.so.2结尾的东西， 其实依赖的是一个文件而不是一个包，这个文件藏身在一个包中)
    - 查询某文件在哪个包中：www.rpmfind.net
4. 安装包的命令 rpm -ivh，详细介绍参看2.2

## 2.2 安装命令

1. 包全名和包名
    - 包全名：操作的包是没有安装的软件包时(安装、升级)，使用包全名。而且要注意路径
    - 包名：操作已安装的软件包时（比如卸载，查询等），使用包名（就是前面的英雄），Linux中所有安装的rpm包，都会保存在/var/lib/rpm/的数据库中，由于包已经装过了，因此版本等相关信息可以不写，只要告诉系统包名，系统就可以在数据库中找到包
    - 包全名就是完整的包名，包名就是指前面的英文。
2.RPM安装
    - 命令：rmp -ivh 包全名
    - 选项：
        ```
        -i(install)　　　 　　 安装
        -v(verbose)　　　　 显示详细信息
        -h(hash)　　　  　　显示进度
        --nodeps　　　　　　不检测依赖性　　//在真正的服务器上决不允许使用
        ```
3. 说明：
    1. 注意要根据提示解决依赖性
    2. 另注意，没有yum软件包，yum装的仍然是rpm包（yum是rpm包的在线安装方法）
    3. yum不支持rpm包的查询和校验，因此要想查询和校验rpm包，只能依赖RPM包查询和RPM包校验（虽然rpm的安装可以用yum来取代，但手工的命令安装是rpm包最基本的方法，因此有必要熟练掌握）

## 2.3 升级与卸载

1. RPM包升级
    - 命令：rpm -Uvh 包全名
    - 选项：-U(upgrade)　　升级
    - 说明：
        - 新的升级包(安装包)对Linux系统来讲是完全陌生的包，所以必须使用包全名，Linux系统才能找到这个包，因此升级也要使用包全名
        - 要想升级，就得要有一个比当前版本更高的一个包，如果没有一个比当前版本更高的包，且旧包已经装过了，那么这个升级包就不会安装
        - 但是，如果升级包(即安装包)没有装过，那么升级命令其实就是纯安装命令，也就是说，其实可以使用升级选项来替代安装选项（看个人习惯）
2. 卸载
    - 命令：rpm -e 包名(不是包全名了)
    - 选项：
        - -e(erase)　　　　卸载
        - --nodeps　　　　不检查依赖性　　//实际操作中不允许使用 
    - 说明：
        - 由于包已经装过，系统会去/var/lib/rmp/目录中的安装数据库(db)里去找，也就是说所有安装的rpm包都会保存信息到数据库里
        - 另外卸载也不一定要在挂载的目录下，因为系统会自动去数据库中找
        - 由于依赖性的原因，卸载要和安装顺序反过来

## 2.4 RPM包查询

> 概述：yum不能查询已经安装好的rpm包，就算采用了yum来进行安装，查询方法还是依赖rpm包的查询，因此rpm包的查询十分常用和重要

1. 查询是否安装

    - rpm -q 包名(不是全包名) //查询包是否已安装
    - -q　　　　查询(query)
    - rpm -qa　　　　//查询所有已安装的rpm包
    - -a　　　　所有(all)
    - 还可以利用管道符进行查询
    - rpm -qa | grep gcc-c++  //注意grep用法
    - 利用此法会列出所有查询的包的相关的包 (似乎比-q更好用？)
2. 查询软件包的详细信息

    - rpm -qi 包名
    - 选项：
        - -i　　查询软件信息(information)
        - -p　　查询未安装包信息(packge)
    - rpm -qip 包全名(未安装的包要使用包全名)　//查询未安装包的详细信息（要进入挂载目录）

3. 查询包中文件安装位置
    - rpm -ql 包名
    - 选项：
        - -l　　　　列表（List）
        - -p　  　　查询未安装包信息(package)
    - RPM包的默认安装位置(只是常规习惯而不是规定)
        - /etc/  配置文件安装目录
        - /usr/bin  可执行的命令安装目录
        - /usr/lib  程序所使用的函数库保存位置
        - /usr/share/doc  基本的软件使用手册保存位置
        - /usr/share/man  帮助文件保存位置　
    - rpm -qlp包全名 //查询未安装包的打算安装的位置（进入挂载目录）

4. 查询系统文件属于哪个rpm包

    - rpm -qf 系统文件名(注意既不是包名也不是包全名)
    - 选项：
    - -f 查询系统文件属于哪个软件包(file)
    - 说明：必须是通过rpm包装出来的文件才能通过此种方式找到相应的rpm包

5. 查询软件包的依赖性
    - rpm -qR 包名
    - 选项：
        - -R　　　　查询软件包的依赖性(requires)
        - -p　　　　查询未安装包信息(Package)
    - 说明：
        - 查询的结果其实意义不大，因为结果会出来好多已经有的东西，更难排除。(比如sbin也会显示)
        - 实际使用更倾向于直接安装让系统报依赖性错误而进行安装
    - rpm -qRp 包全名  //查询未安装包的依赖性（需进入挂载目录）

## 2.5 RPM包校验

1. RPM包校验
    - rpm -V 已安装的包名
    - 选项：-V  校验制定RPM包中的文件（verify）
    - 说明：
        - 若没有显示任何内容，则证明包正常，则没有被修改过
        - 一旦有显示，则证明包被修改过，且会在相应位置显示出被修改过的属性所代表的字母(.说明该属性没有被修改)

    验证内容中8个信息的具体内容如下：
    
    内容 | 含义
    :---: | :---:
    S　　|　　文件大小是否改变
    M　　|　　文件的类型或文件的权限(rwx)是否改变
    5　　|　　文件MD5校验和是否改变（可以看成文件内容是否改变）
    D　　|　　设备的主从代码是否改变
    L　　|　　文件路径是否改变
    U　　|　　文件的属主（所有者）是否改变
    G　　|　　文件的属组是否改变
    T　　|　　文件的修改时间是否改变

    文件类型：
    内容 | 含义
    :---: | :---:
    c　　|　　配置文件（config file）
    d　　|　　普通文档（documentation）
    g　　|　　“鬼”文件（ghost file），很少见，就是该文件不应该被这个rpm包包含
    L　　|　　授权文件（license file）
    r　　|　　描述文件（read me）

    - 若出现鬼文件，有可能是出现漏洞或被攻击的可能
    - 该命令用于验证你的文件与官方提供的文件是否相同，从而判断系统文件是否被做过修改

2. RPM包中文件提取
    - rpm2cpio 包全名 | cpio -idv .文件绝对路径
    -  rpm2cpio　　　　//将rpm包转换为cpio格式的命令
    -  cpio　　　　　　//是一个标准工具，它用于创建软件档案文档和从档案文件中提取文件
    - 若由于误操作，不小心删除某些重要系统命令，如ls等，可以通过rpm包提取文件的方法进行恢复
    - 命令： cpio 选项 < [文件|设备] //可以使用重定向也可以使用管道符
    - 选项：
        - -i　　　　copy-in模式，还原
        - -d　　　　还原时自动创建新目录
        - -v　　　　显示还原过程

    - 比如，不小心删除了ls命令，where is ls
        - mv /bin/ls  /tmp  //由于是做实验，不要真的删除，剪切就好
        - 此时就无法使用ls命令了
        - 接着可以使用cpio从rpm包中提取文件进行恢复
        - 首先 查询ls命令属于哪个软件包 rpm -qf /bin/ls
        - 接着造成误删除ls命令的假象： mv /bin/ls /tmp/
        - 提取rpm包中的ls命令到当前所在目录下： rpm2cpio /mnt/cdrom/Packages/coreutils-8.4-19.el6.i68- rpm | cpio -idv ./bin/ls
            - .表示提取到当前目录,因此要考虑当前所在位置
            - ./bin/ls表示我要提取这个文件
        - 把ls命令复制回/bin/目录，修复文件丢失
        
# 3. yum在线安装

概述：　　
- rpm包的安装过程中，rpm包的依赖性太强，如果所有rpm包都是手工安装，则rpm包使用难度较大，因而出现了yum在线安装的方法
- 好处：将所有软件包放到官方服务器上，当进行yum在线安装时，可以自动解决依赖性的问题
- redhat的yum在线安装需要付费，这就是为什么采用Centos的原因
    
## 3.1 yum源文件

1. Yum源文件
    - 在Linux中，有这样一个目录 /etc/yum.repos.d/，里面有默认4个yum源文件，其中Base是基本yum源文件，它是默认生效的，其他的几个默认都是不生效的
    - 可用vi打开它看一看 `vi /etc/yum.repos.d/CentOS-Base.repo`

- [base]  容器名称，一定要放在[]中  //给yum源起的名字
- name  容器说明，可以自己随便写 //说明，相当于注释或简短的介绍
- mirrorlist  镜像站点，这个可以注释掉
- baseurl  我们的yum源服务器的地址
- enabled  此容器是否生效，如果不写或者写成enabled=1都是生效，enabled=0就是不生效
- gpgcheck  如果是1是指RPM的数字证书验证，如果是0则不验证(建议开启，若下载了一个非法的、不是官方的rpm包，会报错)
- gpgkey  数字证书的公钥文件保存位置。不用修改(系统中存在的证书)
- yum源服务器的地址默认是CentOS官方的yum源服务器，是可以使用的，如果你觉得慢可以改成你喜欢的yum源地址，如国内的yum源地址
- 如果能够上网，默认是Base的yum源文件生效，可以直接访问安装

## 3.2 光盘yum源搭建

yum源默认是用网络作为yum源，在一些特殊情况下，比如教学、实验室等，不是所有的环境都可以联网，这种不能使用网络的情况下，可以使用光盘搭建yum源，我们知道，光盘包含了所有的rpm包，因此使用光盘搭建本地yum源是可行的。

1. 挂载光盘
    - 建立挂载点 mkdir /mnt/cdrom
    - 挂载光盘(注意虚拟机要打开光驱并选择需要的镜像)
        - mount /dev/sr0 /mnt/cdrom/
        - 或 mount /dev/cdrom /mnt/cdrom　　//cdrom好像是sr0的链接
2. 使网络yum源失效

    - 进入yum源目录 cd /etc/yum.repos.d/
    - 修改yum源文件后缀名，使其失效  mv CentOS-Base.repo CentOS-Base.repo.bak　
    - 说明：
        - 其实可以在CentOS-Base.repo文件中加入enabled=0使其生效，
        - 但是CentOS-Base.repo默认生效的有3个，修改较为繁琐，
        - 故此采用将其改个名，加个后缀，使其失效
        - 因为以后可能又想在线安装了，故不建议删除　　
3. 使光盘yum源（CentOS-Media.repo）生效
    - vim Centos-Media.repo　　#具体参数含义可以参考前面的介绍

    ```
    [c6-media]
    name=CentOS-$releasever - Media
    baseurl=file:///mnt/cdrom  #地址为你自己的光盘挂载地址
    #  file:///media/cdrom
    #  file:///media/cdrecorder/  #注释这两个不存在的地址
    gpgcheck=1
    enabled=1  #把enabled=0改为enabled=1,让这个yum源配置文件生效
    gpgkey=file:///ect/pki/rpm-gpg/RPM-GPG-KEY-CentOS-6　　#默认就是这个，不要修改即可
    ```
    - 可以使用命令 yum list 查看yum源里有哪些软件包可以安装，以便检查yum源是否搭建好
        - yum list  #列出的结果 其yum源显示为容器名
    - 光盘yum源成功搭建后，即可使用yum进行安装了
    
## 3.3 yum命令

1. 常用yum命令

    - 查询
        - yum list　　#查询所有可用软件包列表(以 包名 - 版本 - yum源所在名称 格式显示)
        - yum search 关键字　　#搜索服务器上所有和关键字相关的包
    - 安装
        - yum -y install 包名（不需要包全名，只要包名即可）
        - 选项:
            - install  安装
            - -y  自动回答yes
            - 例如 yum -y install gcc
    - 升级
        - yum  -y update 包名（不用包全名）
        - 选项：
            - update  升级
            - -y  自动回答yes
        - 说明:
            - 升级有个前提条件，就是在yum源里有更高版本的相应软件，否则不能升级
            - 对服务器来说升级需要付出代价，可能会造成损失，并且升级的软件包也不一定可靠和安全
            - 对Linux来讲考虑的是稳定和安全，除非爆发致命性的漏洞，否则应尽量能不升级则尽量不升级
            - 尽量不要这么写命令： yum -y update --->这会升级Linux中的所有程序，包括内核
                - 首先，会非常浪费时间，
                - 其次，内核的升级需要对本地服务器做一些相应的配置和修改才能使用，
                - 如果服务器放在远程，那么对服务器的操作就不能及时进行。
                - 也就是说，敢这么执行命令，Linux系统基本直接崩溃
                - 因为新内核需要进行配置，而旧内核已经被你的命令给替换了，因此，慎用！！！
    - 卸载
        - yum -y remove 包名　　　　//不建议使用
        - 选项：
            - remove  卸载
            - -y  自动回答yes
        - 说明：
            - 服务器安装原则：服务器使用最小化安装，用什么软件安装什么，尽量不卸载。
            - 卸载也会有依赖性，若卸载一个不太熟悉的包，会引起一系列连锁反应，甚至可能会导致系统崩溃

2. YUM软件组管理命令

- yum grouplist  #列出所有可用的软件组列表
- Linux本机不支持中文显示，LANG=en_US //改成英文语系，然后安装软件组即可 //软件组名需要使用英文组名
- `LANG=zh_CN.utf8` 或 `LANG=zh_CN.utf-8`　　//改成中文语系
- yum groupinstall 软件组名  #安装指定软件组，组名可以由grouplist查询出来
- yum groupremove 软件组名  #卸载指定软件组

# 4. 源码包在线安装

## 4.1 源码包与RPM包的区别

1. 区别

    - 安装之前的区别：概念上的不同(是否开源等，更多请点我)
    - 安装之后的区别：安装位置不同

2. RPM包安装位置

    - 是安装在默认位置中，但不是确切的
    - RPM包默认安装路径：
        - /etc/　　　　　　　　配置文件安装目录
        - /usr/bin/　　　　　　可执行的命令安装目录
        - /usr/lib/　　　　　　 程序所使用的函数库保存位置
        - /usr/share/doc/　　　基本的软件使用手册保存位置
        - /usr/share/man/　　 帮助文件保存位置
    - RPM包安装建议不要指定安装位置
    - 虽然RPM包会装的到处都是，但是可以使用命令卸载，不会留下垃圾

3. 源码包安装位置

    - 安装在指定位置当中，一般是 /usr/local/软件名/ (相当于Windows下的program)
    - 源码包没有卸载命令，卸载就是删除源码包安装位置，因此源码包一定要安装在指定目录下

4. 安装位置不同带来的影响

    - RPM包安装的服务可以使用系统服务管理命令（service）来管理，例如RPM包安装的apache的启动方法是：
    - /etc/rc.d/init.d/httpd start
    - service httpd start
    - 若指定安装位置可能会造成标准的启动方式无法识别
    - 而源码包安装的服务则不能被服务管理命令所管理，因为没有安装到默认路径中。
    - 所以只能使用绝对路径进行服务的管理，如：
        - /usr/local/apache2/bin/apachectl start
    - service搜索的命令实际是 /etc/rc.d/init.d/目录下的软件，因此可以将软件拷贝到该目录下实现service搜索。

## 4.2 源码包安装过程

1. 安装准备

    - 安装C语言编译器 gcc
    - 下载源码包: http://mirror.bit.edu.cn/apache/httpd/
        - 下载2.2.9的httpd
    - 可以使用WinSCP将本机上的软件拷贝到虚拟机，注意更改权限
    - rpm和源码包可以分别安装，但是只能起用一个。因为占用相同端口80

2. 安装注意事项
    - 源代码保存位置： /usr/local/src
    - 软件安装位置： /usr/local/
    - 如何确定安装过程报错：
    - 安装过程停止，并出现error,warning或no的提示　　　　

3. 源码包安装过程

    - 下载源码包
        - http://mirror.bit.edu.cn/apache/httpd/  下载httpd2.2.9或其他版本
    - 解压缩下载的源码包
        - tar -zxvf httpd-2.2.9.tar.gz
    - 进入解压缩目录（必须要执行）
        - cd httpd-2.2.9　　#注意，这条命令不是可选项，而是必须执行，
        - #因为后面讲的相关命令，操作的是当前目录，若没有进入解压缩目录则操作的是其他目录
    - ./configure　　软件配置与检查 　　
        - #基本上每个源码包都有这个命令，就算没有，也会有类似的命令取代其工作
        - 定义需要的功能选项　　--help
        - 检测系统环境是否符合安装要求
        - 把定义好的功能选项和检测系统环境的信息都写入Makefile文件，用于后续的编辑
        - ./configure --prefix=/usr/local/apache2
    - make编译
        - make clean　　　　#若报错，可使用make clean清楚编译生成的缓存文件
    - make install　　编译安装
    - 启动
        - /usr/local/apache2/bin/apachectl start　　　　#看具体软件提供的命令
    - 若已经启动了rpm包安装的阿帕奇，则需先将rpm包的阿帕奇停掉
        - service httpd stop
    - 具体安装和启动可以参考安装说明文档

4. 源码包的卸载

    - 不需要卸载命令，直接删除安装目录即可。不会遗留任何垃圾文件
    
# 5. 脚本安装包

> 概述：其实在Linux中是不存在脚本安装包这种安装包的，Linux就源码包和rpm包两种，所谓的脚本安装包就是把复杂的安装过程写成了一个阿帕奇脚本，他实际上安装的还是源码包或者rpm包

强大的Nginx服务器的脚本安装包演示：
1. 准备工作

    - 关闭安装的httpd和MySQL
        - /usr/local/apache2/bin/apachectl stop
        - rm -rf /usr/local/apache2
        - service httpd stop　　#有需要就关
        - service mysqld stop　　#有需要就关
    - 保证yum源正常使用
        - yum list
    - 关闭SELinux和防火墙
        - SELinux:Linux安全增强组件
        - vi /etc/selinux/config 
        - 将默认的enforcing 改成 disabled 重启就会关闭
2. 下载
    - http://lnmp.org/install.html　　　　#建议下载完整版
    - 使用WinSCP拷贝到Linux中

3. 脚本一键安装
    - 解压缩 tar -zxvf lnmp1.0-full.tar.gz
    - 安装LNMP执行命令:
        - ./centos.sh 
4. centos.sh脚本分析

    - 所谓的一键安装包，实际上还是安装的源码包与RPM包，只是把安装过程写成了脚本，便于初学者安装
    - 优点：简单、快捷、方便
    - 缺点：
        - 不能定义安装软件的版本
        - 不能定义所需要的软件功能
        - 源码包的优势丧失
    
    